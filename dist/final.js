(()=>{"use strict";const e=require("express"),o=require("cors"),r=require("ytdl-core"),t=require("fs"),n=require("ffmpeg-static"),s=require("fluent-ffmpeg"),i=require("path"),a=require("wavefile"),l=require("@xenova/transformers"),c=require("url");l.env.allowLocalModels=!1;const u=(0,c.fileURLToPath)("file:///home/escobar/Desktop/study/boracodar/Video%20Transcription%20AI/server/transcribe.js"),R=i.dirname(u);const p=e();p.use(o()),p.get("/audio",(async(e,o)=>{const c=e.query.videoId;try{await(e=>new Promise(((o,n)=>{const s=r(`https://www.youtube.com/watch?v=${e}`,{quality:"highestaudio",filter:"audioonly"});s.on("end",(()=>{console.log("[FINISHED_DOWNLOAD]"),o()})),s.on("error",(e=>{console.error("[ERROR_DOWNLOAD]"),n("[ERROR_DOWNLOADING_VIDEO]")})),s.pipe(t.createWriteStream("./audio.mp4"))})))(c),await new Promise(((e,o)=>{s.setFfmpegPath(n),s().input("audio.mp4").outputOptions("-ab","20k").saveToFile("audio.wav").on("end",(()=>{console.log("[AUDIO_CONVERTED]"),e()})).on("error",(e=>{console.log(e),o("[AUDIO_CONVERTER_ERROR]",e)}))}));const e=await async function(){const e={chunk_length_s:30,stride_length_s:5,language:"portuguese",task:"transcribe",return_timestamps:!0};try{const o=await(0,l.pipeline)("automatic-speech-recognition","Xenova/whisper-medium"),r=await async function(){console.log("[START_TO_GET_AUDIO_WAV]");const e=i.resolve(R,"../audio.wav"),o=t.readFileSync(e);let r=new a.WaveFile(o);r.toBitDepth("32f"),r.toSampleRate(16e3);let n=r.getSamples();if(Array.isArray(n)){if(n.length>1){const e=Math.sqrt(2);for(let o=0;o<n[0].length;++o)n[0][o]=e*(n[0][o]+n[1][o])/2}n=n[0]}return console.log("[END_TO_GET_AUDIO_WAV]"),n}();console.log(["START_TRANSCRIPTION",r.length]),console.time("[TRANSCRIBE]");const n=await o(r,e);return console.timeEnd("[TRANSCRIBE]"),console.log("[TRANSCRIPTION_RESULT]",n),n}catch(e){throw console.error("[TRANSCRIBE_ERROR]",e),new Error}}();return o.json(e)}catch(e){return console.error(e),o.status(500).send("Internal server error")}})),p.listen(3333,(()=>console.log("Server is running on port 3333")))})();